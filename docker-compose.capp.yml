services:
  # 2C 自己的数据库（如果你暂时不需要，可以先去掉这一块）
  capp-db:
    image: postgres:17
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${CAPP_DB_USER} -d ${CAPP_DB_NAME}"]
      interval: 10s
      retries: 5
      start_period: 30s
      timeout: 10s
    volumes:
      - capp-db-data:/var/lib/postgresql/data/pgdata
    env_file:
      - .env
    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
      - POSTGRES_USER=${CAPP_DB_USER?Variable not set}
      - POSTGRES_PASSWORD=${CAPP_DB_PASSWORD?Variable not set}
      - POSTGRES_DB=${CAPP_DB_NAME?Variable not set}
    networks:
      - traefik-public
      - capp-net

  # 2C backend (Node.js, capp/backend)
  capp-backend:
    build:
      context: ./capp/backend
      dockerfile: Dockerfile
    image: ${DOCKER_IMAGE_CAPP_BACKEND:-lingadmin-capp-backend}
    restart: always
    env_file:
      - .env
    environment:
      - PORT=4000
      - NODE_ENV=production
      # 如果用 capp-db：
      - POSTGRES_SERVER=capp-db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${CAPP_DB_NAME?Variable not set}
      - POSTGRES_USER=${CAPP_DB_USER?Variable not set}
      - POSTGRES_PASSWORD=${CAPP_DB_PASSWORD?Variable not set}
    depends_on:
      capp-db:
        condition: service_healthy
    networks:
      - traefik-public
      - capp-net
    ports:
      - "4000:4000"      
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik-public
      - traefik.constraint-label=traefik-public
      # 服务内部端口
      - traefik.http.services.${STACK_NAME_CAPP?Variable not set}-backend2c.loadbalancer.server.port=4000
      # HTTP router
      - traefik.http.routers.${STACK_NAME_CAPP?Variable not set}-backend2c-http.rule=Host(`c-api.${DOMAIN?Variable not set}`)
      - traefik.http.routers.${STACK_NAME_CAPP?Variable not set}-backend2c-http.entrypoints=http
      - traefik.http.routers.${STACK_NAME_CAPP?Variable not set}-backend2c-http.middlewares=https-redirect
      # HTTPS router
      - traefik.http.routers.${STACK_NAME_CAPP?Variable not set}-backend2c-https.rule=Host(`c-api.${DOMAIN?Variable not set}`)
      - traefik.http.routers.${STACK_NAME_CAPP?Variable not set}-backend2c-https.entrypoints=https
      - traefik.http.routers.${STACK_NAME_CAPP?Variable not set}-backend2c-https.tls=true
      - traefik.http.routers.${STACK_NAME_CAPP?Variable not set}-backend2c-https.tls.certresolver=le

  # 2C frontend (React, capp/frontend)
  capp-frontend:
    build:
      context: ./capp/frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: "https://c-api.${DOMAIN?Variable not set}"
        NODE_ENV: "production"
    image: ${DOCKER_IMAGE_CAPP_FRONTEND:-lingadmin-capp-frontend}
    restart: always
    depends_on:
      - capp-backend
    networks:
      - traefik-public
      - capp-net
    ports:
      - "5174:80"      
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik-public
      - traefik.constraint-label=traefik-public
      # 内部服务端口 (nginx 或静态服务器端口)
      - traefik.http.services.${STACK_NAME_CAPP?Variable not set}-frontend2c.loadbalancer.server.port=80
      # HTTP router
      - traefik.http.routers.${STACK_NAME_CAPP?Variable not set}-frontend2c-http.rule=Host(`c.${DOMAIN?Variable not set}`)
      - traefik.http.routers.${STACK_NAME_CAPP?Variable not set}-frontend2c-http.entrypoints=http
      - traefik.http.routers.${STACK_NAME_CAPP?Variable not set}-frontend2c-http.middlewares=https-redirect
      # HTTPS router
      - traefik.http.routers.${STACK_NAME_CAPP?Variable not set}-frontend2c-https.rule=Host(`c.${DOMAIN?Variable not set}`)
      - traefik.http.routers.${STACK_NAME_CAPP?Variable not set}-frontend2c-https.entrypoints=https
      - traefik.http.routers.${STACK_NAME_CAPP?Variable not set}-frontend2c-https.tls=true
      - traefik.http.routers.${STACK_NAME_CAPP?Variable not set}-frontend2c-https.tls.certresolver=le

volumes:
  capp-db-data:

networks:
  traefik-public:
    external: true
  capp-net:
    driver: bridge
